# https://docs.github.com/actions
name: Deploy Chat

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµæ°´çº¿
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - app/**/**
      - package.json
      - .github/workflows/deploy_chat.yml

jobs:
  run:
    name: Chat Build & Deploy
    runs-on: ubuntu-latest

    env:
      # é…ç½®: https://github.com/oceanopen/ChatGPT-Next-Web/settings/secrets/actions
      remote_host: ${{ secrets.CVM_IP }}
      remote_user: ${{ secrets.CVM_USER_NAME }}
      remote_ssh_key: ${{ secrets.CVM_PRIVATE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # https://github.com/marketplace/actions/checkout

      - name: Setup Node
        uses: actions/setup-node@v4 # https://github.com/marketplace/actions/setup-node-js-environment
        with:
          node-version: 22

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-

      # 'true' - ä»£è¡¨ç¼“å­˜å‘½ä¸­, node_modules æ²¡æœ‰å˜åŒ–;
      # '' - ä»£è¡¨æ²¡æœ‰å‘½ä¸­, node_modules å‘ç”Ÿå˜åŒ–;
      - name: Debug Cache Hit
        run: echo "cache-node-modules:${{ steps.cache-node-modules.outputs.cache-hit }}"

      - name: Install yarn
        run: npm install -g yarn

      # This project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
      - name: Install dependencies and Build ğŸ”§
        run: yarn install && yarn build:next && yarn build:dist

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main # https://github.com/marketplace/actions/ssh-deploy
        if: env.remote_host && env.remote_user && env.remote_ssh_key
        with:
          # æœåŠ¡å™¨åŸŸå
          REMOTE_HOST: ${{ secrets.CVM_IP }}
          # è…¾è®¯äº‘é»˜è®¤ç”¨æˆ·åä¸º root
          REMOTE_USER: ${{ secrets.CVM_USER_NAME }}
          # æœ¬åœ° .ssh æ–‡ä»¶ä¸‹çš„ç§é’¥ id_rsaï¼Œå­˜åœ¨ secrets çš„ TOKEN ä¸­
          SSH_PRIVATE_KEY: ${{ secrets.CVM_PRIVATE_KEY }}
          # å¤åˆ¶æ“ä½œçš„å‚æ•°ã€‚For any initial/required rsync flags.
          # é»˜è®¤ä¸º "-rlgoDzvc -i", è¡¨ç¤ºä¿ç•™å·²æœ‰çš„æ–‡ä»¶
          # "-avzr --delete" æ„å‘³éƒ¨ç½²æ—¶æ¸…ç©ºæœåŠ¡å™¨ç›®æ ‡ç›®å½•ä¸‹çš„æ–‡ä»¶
          ARGS: -avzr --delete
          # æºç›®å½•ï¼Œç›¸å¯¹äº $GITHUB_WORKSPACE æ ¹ç›®å½•çš„è·¯å¾„
          SOURCE: dist/
          # ç›®æ ‡ç›®å½•
          TARGET: /data/web/${{ github.event.repository.name }}/dist

      - name: Remote SSH Run
        uses: appleboy/ssh-action@master # https://github.com/appleboy/ssh-action/tree/master/
        if: env.remote_host && env.remote_user && env.remote_ssh_key
        with:
          host: ${{ secrets.CVM_IP }}
          username: ${{ secrets.CVM_USER_NAME }}
          key: ${{ secrets.CVM_PRIVATE_KEY }}
          # è¿™é‡Œ workflow æ‰§è¡Œ "sh restart.sh" ä¼šæ‰§è¡ŒæŠ¥é”™ "node: command not found", æ•…æ”¹ä¸ºéƒ¨ç½²æ›´æ–°åæ‰‹åŠ¨æ‰§è¡Œ
          script: |
            cd /data/web/${{ github.event.repository.name }}/
            cp -f .env ./dist/
            cp ./dist/ecosystem.config.js ./
            cp ./dist/restart.sh ./
